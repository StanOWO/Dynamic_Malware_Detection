# -*- coding: utf-8 -*-
"""
Created on Tue Apr 15 22:53:20 2024

@author: Stan Wang
"""
import os
import json

def add_data(call, key, value):
    if key in call:
        call[key].append(value)
    else:
        call[key] = [value]

def add_result(result, key, value, time_range):
    if not(key in result):
        result[key] = [0] * 16
    for i in range(16):
        if time_range[i] > value:
            result[key][i] += 1
            break
        
def main(report_dir, count):
    files= os.listdir(report_dir)
    for counter, filename in enumerate(files):
        with open(report_dir + filename + "/reports/report.json", "r") as f:
            data = json.load(f)
        
        haveData=False
        if "behavior" not in data:
            continue
        for c in range(0, len(data['behavior']['processes'])):
            if data['behavior']['processes'][c]['process_path'].find('VirusShare') != -1:
                haveData=True
                print("Number：",count)
                print("filePath："+data['behavior']['processes'][c]['process_path'])
                count+=1
                break

        if not haveData:
            continue
        
        name ="VirusShare"+ data['behavior']['processes'][c]['process_path'].split("VirusShare")[1].split(".")[0]
       
        calls = data['behavior']['processes'][c]['calls']

        call = {}

        min = calls[0]['time']
        max = calls[0]['time']
        for i in range(1, len(calls)):
            add_data(call, calls[i]['category'], calls[i]['time'])
            if(min > calls[i]['time']):
                min = calls[i]['time']
            if(max < calls[i]['time']):
                max = calls[i]['time']

        interval = (max - min) / 16

        time_range = [min + interval * (i + 1) for i in range(16)]

        result = {}

        for key, values in call.items():
            for value in values:
                add_result(result, key, value, time_range)

        with open("json_data/"+name+".json", 'w') as f:
            json.dump(result, f)
    print("complete!")

if __name__=="__main__":
    report_dir = "./report_data/"
    count=1
    
    main(report_dir, count)